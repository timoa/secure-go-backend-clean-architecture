name: Build

on: [push]

# Declare default permissions as read only.
permissions: read-all

jobs:

  # -- TESTS ------------------------------------------------------------------
  unit-tests:
    name: Unit-Tests
    runs-on: ubuntu-latest

    steps:
      - name: Harden GitHub Actions Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: block
          allowed-endpoints: >
            agent.api.stepsecurity.io:443
            api.github.com:443
            github.com:443
            objects.githubusercontent.com:443
            proxy.golang.org:443
            storage.googleapis.com:443
            sum.golang.org:443
            release-assets.githubusercontent.com:443
            releases.bazel.build:443
            bcr.bazel.build:443
            go.dev:443
            dl.google.com:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Bazelisk
        run: |
          mkdir -p "$HOME/.local/bin"
          curl --fail --location --proto '=https' --proto-redir '=https' --tlsv1.2 -o "$HOME/.local/bin/bazelisk" https://github.com/bazelbuild/bazelisk/releases/download/v1.27.0/bazelisk-linux-amd64
          chmod +x "$HOME/.local/bin/bazelisk"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Bazel Cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cache/bazel
          key: ${{ runner.os }}-bazel-${{ hashFiles('.bazelversion', 'MODULE.bazel', 'MODULE.bazel.lock', 'go.mod', 'go.sum') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      - name: Build the app (Bazel)
        run: bazelisk build //cmd:main

      - name: Run the tests (Bazel)
        run: bazelisk test //...

      - name: Setup Go (coverage only)
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          check-latest: true
          cache: true

      - name: Generate Go coverage.out (SonarCloud)
        run: make coverage

      - name: Save Code Coverage
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: code-coverage
          path: coverage.out

  # -- E2E --------------------------------------------------------------------
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Harden GitHub Actions Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit
          # allowed-endpoints: >
          #   agent.api.stepsecurity.io:443
          #   api.github.com:443
          #   auth.docker.io:443
          #   docker.io:443
          #   dl.google.com:443
          #   go.dev:443
          #   github.com:443
          #   objects.githubusercontent.com:443
          #   production.cloudflare.docker.com:443
          #   proxy.golang.org:443
          #   releases.bazel.build:443
          #   bcr.bazel.build:443
          #   registry-1.docker.io:443
          #   storage.googleapis.com:443
          #   sum.golang.org:443
          #   release-assets.githubusercontent.com:443
          #   golang.org:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          check-latest: true
          cache: true

      - name: Create .env for CI
        run: |
          cp .env.example .env

          sed -i 's/^ACCESS_TOKEN_EXPIRY_HOUR[[:space:]]*=[[:space:]]*/ACCESS_TOKEN_EXPIRY_HOUR=/' .env
          sed -i 's/^REFRESH_TOKEN_EXPIRY_HOUR[[:space:]]*=[[:space:]]*/REFRESH_TOKEN_EXPIRY_HOUR=/' .env

          sed -i 's/^APP_ENV=.*/APP_ENV=ci/' .env
          sed -i 's/^SERVER_ADDRESS=.*/SERVER_ADDRESS=:8080/' .env
          sed -i 's/^PORT=.*/PORT=8080/' .env
          sed -i 's/^DB_HOST=.*/DB_HOST=mongodb/' .env
          sed -i 's/^DB_PORT=.*/DB_PORT=27017/' .env
          sed -i 's/^DB_USER=.*/DB_USER=/' .env
          sed -i 's/^DB_PASS=.*/DB_PASS=/' .env
          sed -i 's/^ACCESS_TOKEN_SECRET=.*/ACCESS_TOKEN_SECRET=ci_access_token_secret/' .env
          sed -i 's/^REFRESH_TOKEN_SECRET=.*/REFRESH_TOKEN_SECRET=ci_refresh_token_secret/' .env

      - name: Start stack (Docker Compose)
        run: docker compose up -d --build

      - name: Wait for API health
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/health >/dev/null; then
              echo "API is healthy"
              exit 0
            fi
            sleep 2
          done
          echo "API did not become healthy in time"
          docker compose ps
          docker compose logs --no-color
          exit 1

      - name: Run E2E tests
        env:
          BASE_URL: http://localhost:8080
        run: go test -tags=e2e ./tests/e2e -v

      - name: Dump Docker Compose logs on failure
        if: failure()
        run: docker compose logs --no-color

      - name: Tear down stack
        if: always()
        run: docker compose down -v

  # -- SONARCLOUD -------------------------------------------------------------
  code-quality:
    name : Code Quality
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Harden GitHub Actions Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download Code Coverage
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: code-coverage

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # -- SAST SCAN --------------------------------------------------------------
  code-security:
    name: Code Security
    runs-on: ubuntu-latest
    needs:
      - unit-tests
    # Skip any PR created by dependabot to avoid permission issues
    if: (github.actor != 'dependabot[bot]')

    steps:
      - name: Harden GitHub Actions Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            auth.docker.io:443
            docker.io:443
            github.com:443
            golang.org:443
            nvd.nist.gov:443
            objects.githubusercontent.com:443
            osv-vulnerabilities.storage.googleapis.com:443
            production.cloudflare.docker.com:443
            proxy.golang.org:443
            pypi.org:443
            registry-1.docker.io:443
            storage.googleapis.com:443
            sum.golang.org:443
            release-assets.githubusercontent.com:443
            releases.bazel.build:443
            bcr.bazel.build:443
            go.dev:443
            dl.google.com:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Bazelisk
        run: |
          mkdir -p "$HOME/.local/bin"
          curl --fail --location --proto '=https' --proto-redir '=https' --tlsv1.2 -o "$HOME/.local/bin/bazelisk" https://github.com/bazelbuild/bazelisk/releases/download/v1.27.0/bazelisk-linux-amd64
          chmod +x "$HOME/.local/bin/bazelisk"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Bazel Cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cache/bazel
          key: ${{ runner.os }}-bazel-${{ hashFiles('.bazelversion', 'MODULE.bazel', 'MODULE.bazel.lock', 'go.mod', 'go.sum') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      - name: Build app (Bazel)
        run: bazelisk build //cmd:main

      - name: Perform Scan
        uses: ShiftLeftSecurity/scan-action@master

        env:
          WORKSPACE: https://github.com/${{ github.repository }}/blob/${{ github.sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SCAN_ANNOTATE_PR: true

      - name: Save the reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: reports
          path: reports

  # -- PRE-RELEASE ------------------------------------------------------------
  pre-release:
    name: Pre-Release
    runs-on: ubuntu-latest
    needs:
      - e2e-tests
      - code-quality
      - code-security
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
      - name: Harden GitHub Actions Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: 'main' # Force checkout of main branch to avoid cache from previous jobs
          persist-credentials: false

      - name: Prepare Release
        uses: cycjimmy/semantic-release-action@b12c8f6015dc215fe37bc154d4ad456dd3833c90 # v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
